<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Next.js 에서 react-query 쓰기: Server Rendering &amp; Hydration  | Wh@t !s Development?</title>
    <meta name="generator" content="VuePress 1.9.10">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-C7NTCRQ25E"></script>
    <script>window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-C7NTCRQ25E');</script>
    <meta name="description" content="배워가고 있는 현업..? 대학생 개발자">
    
    <link rel="preload" href="/assets/css/0.styles.410c9d99.css" as="style"><link rel="preload" href="/assets/js/app.0f0432c3.js" as="script"><link rel="preload" href="/assets/js/1.e51d5c6a.js" as="script"><link rel="preload" href="/assets/js/38.9f1b4753.js" as="script"><link rel="prefetch" href="/assets/js/10.af576f8c.js"><link rel="prefetch" href="/assets/js/11.8e7b7e6a.js"><link rel="prefetch" href="/assets/js/12.5d214f46.js"><link rel="prefetch" href="/assets/js/13.9a7e722a.js"><link rel="prefetch" href="/assets/js/14.5257cb5d.js"><link rel="prefetch" href="/assets/js/15.f5323db5.js"><link rel="prefetch" href="/assets/js/16.21bdef53.js"><link rel="prefetch" href="/assets/js/17.a26c4187.js"><link rel="prefetch" href="/assets/js/18.cc5832b6.js"><link rel="prefetch" href="/assets/js/19.9c2a758e.js"><link rel="prefetch" href="/assets/js/2.a73cb97e.js"><link rel="prefetch" href="/assets/js/20.274e5be3.js"><link rel="prefetch" href="/assets/js/21.aad67e55.js"><link rel="prefetch" href="/assets/js/22.6699120b.js"><link rel="prefetch" href="/assets/js/23.62e88c29.js"><link rel="prefetch" href="/assets/js/24.a9e172f9.js"><link rel="prefetch" href="/assets/js/25.9f6d5201.js"><link rel="prefetch" href="/assets/js/26.c6576b86.js"><link rel="prefetch" href="/assets/js/27.11b8553b.js"><link rel="prefetch" href="/assets/js/28.4f235f30.js"><link rel="prefetch" href="/assets/js/29.d9921336.js"><link rel="prefetch" href="/assets/js/30.49a4c0a3.js"><link rel="prefetch" href="/assets/js/31.581f6903.js"><link rel="prefetch" href="/assets/js/32.35749f3d.js"><link rel="prefetch" href="/assets/js/33.0eeaf8b7.js"><link rel="prefetch" href="/assets/js/34.bc5efa62.js"><link rel="prefetch" href="/assets/js/35.bc5e7fdd.js"><link rel="prefetch" href="/assets/js/36.8eb956e4.js"><link rel="prefetch" href="/assets/js/37.f00c8127.js"><link rel="prefetch" href="/assets/js/39.ba3af032.js"><link rel="prefetch" href="/assets/js/4.fa591364.js"><link rel="prefetch" href="/assets/js/40.ce9157d5.js"><link rel="prefetch" href="/assets/js/41.55cf01b3.js"><link rel="prefetch" href="/assets/js/42.13adade4.js"><link rel="prefetch" href="/assets/js/43.82fd5a46.js"><link rel="prefetch" href="/assets/js/44.69524c43.js"><link rel="prefetch" href="/assets/js/45.b5148874.js"><link rel="prefetch" href="/assets/js/46.8c9eea5a.js"><link rel="prefetch" href="/assets/js/47.1c6d2034.js"><link rel="prefetch" href="/assets/js/48.e5d7163d.js"><link rel="prefetch" href="/assets/js/49.2be3dee3.js"><link rel="prefetch" href="/assets/js/5.3285373e.js"><link rel="prefetch" href="/assets/js/50.1bc83e1d.js"><link rel="prefetch" href="/assets/js/51.86405db6.js"><link rel="prefetch" href="/assets/js/52.9992785d.js"><link rel="prefetch" href="/assets/js/53.cd97a3e5.js"><link rel="prefetch" href="/assets/js/54.fc7e5d0e.js"><link rel="prefetch" href="/assets/js/55.ee855e74.js"><link rel="prefetch" href="/assets/js/56.b71f792d.js"><link rel="prefetch" href="/assets/js/57.6c9afba0.js"><link rel="prefetch" href="/assets/js/58.ee457792.js"><link rel="prefetch" href="/assets/js/59.9de3ac46.js"><link rel="prefetch" href="/assets/js/6.1892a22d.js"><link rel="prefetch" href="/assets/js/60.66e2b70d.js"><link rel="prefetch" href="/assets/js/61.4ca17ece.js"><link rel="prefetch" href="/assets/js/62.1e40c143.js"><link rel="prefetch" href="/assets/js/63.349b896e.js"><link rel="prefetch" href="/assets/js/64.5ced3a0a.js"><link rel="prefetch" href="/assets/js/65.885a6b59.js"><link rel="prefetch" href="/assets/js/66.d33066c0.js"><link rel="prefetch" href="/assets/js/67.6cd8cdbb.js"><link rel="prefetch" href="/assets/js/68.b938c024.js"><link rel="prefetch" href="/assets/js/69.78092bd2.js"><link rel="prefetch" href="/assets/js/7.b7ddbb1c.js"><link rel="prefetch" href="/assets/js/70.3652d64c.js"><link rel="prefetch" href="/assets/js/71.97470014.js"><link rel="prefetch" href="/assets/js/72.3f43251e.js"><link rel="prefetch" href="/assets/js/73.4b1b6c82.js"><link rel="prefetch" href="/assets/js/74.a5c70ed4.js"><link rel="prefetch" href="/assets/js/75.126ed59b.js"><link rel="prefetch" href="/assets/js/76.7a449595.js"><link rel="prefetch" href="/assets/js/77.e9dda385.js"><link rel="prefetch" href="/assets/js/78.6910c049.js"><link rel="prefetch" href="/assets/js/79.f79dfc27.js"><link rel="prefetch" href="/assets/js/8.d36f1bbf.js"><link rel="prefetch" href="/assets/js/80.7d6014ad.js"><link rel="prefetch" href="/assets/js/81.f9600c48.js"><link rel="prefetch" href="/assets/js/82.46c9d211.js"><link rel="prefetch" href="/assets/js/83.ffbaed47.js"><link rel="prefetch" href="/assets/js/84.7c6d7c27.js"><link rel="prefetch" href="/assets/js/85.9c073b0f.js"><link rel="prefetch" href="/assets/js/86.bafebd90.js"><link rel="prefetch" href="/assets/js/87.05edd0bf.js"><link rel="prefetch" href="/assets/js/88.3123c9a0.js"><link rel="prefetch" href="/assets/js/89.607daa32.js"><link rel="prefetch" href="/assets/js/9.2f254d8e.js"><link rel="prefetch" href="/assets/js/90.21814a61.js"><link rel="prefetch" href="/assets/js/91.47d6c698.js">
    <link rel="stylesheet" href="/assets/css/0.styles.410c9d99.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="layout"><div id="navbar"><nav role="navigation" aria-label="main navigation" class="navbar"><div class="navbar-brand"><a href="/" class="navbar-item" style="font-weight:bold;color:black;">
      Wh@t !s Development?
    </a><a role="button" aria-label="menu" tabindex="0" class="navbar-burger burger"><span aria-hidden="true"></span><span aria-hidden="true"></span><span aria-hidden="true"></span></a></div><div class="navbar-menu"><div class="navbar-start"></div><div class="navbar-end"><a href="/" class="navbar-item">
      Home
    </a><a href="/about" class="navbar-item">
      About
    </a> <a href="/posts/app" class="navbar-item">
      앱
    </a><a href="/posts/cs" class="navbar-item">
      CS
    </a><a href="/posts/web" class="navbar-item">
      Web
    </a><a href="/posts/etc" class="navbar-item">
      그 외
    </a> <div class="navbar-item"><div class="buttons"><button type="button" class="button is-info"><!----><!----><span class="icon is-small"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="svg-inline--fa fa-github fa-w-16"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></span></button> <button type="button" class="button is-info"><!----><!----><span class="icon is-small"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="instagram" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="svg-inline--fa fa-instagram fa-w-14"><path fill="currentColor" d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"></path></svg></span></button> <button type="button" class="button is-info"><!----><span><span class="icon is-small"><img src="/images/white_notion.svg" width="15" height="15"></span></span><!----></button></div></div></div></div></nav></div> <div class="content"><div class="page post"><div class="columns"><div class="column"><p class="title is-4">Next.js 에서 react-query 쓰기: Server Rendering &amp; Hydration </p></div></div> <p class="subtitle is-5 date">2024-04-15 20:46:00</p> <div class="content__default" style="paddig:0;"><img src="/assets/img/1.05dbf075.png"> <h2 id="queryclientprovider에-캐시된-클라이언트-주입">QueryClientProvider에 캐시된 클라이언트 주입</h2> <p>리액트 쿼리 공식 문서의 “고급 서버 렌더링” 문서를 보고 우선 구현에 들어갔다.</p> <p>우선 공식 문서에서 하라는대로 QueryClientProvider에 캐시된 쿼리 클라이언트를 넘겨줬다.</p> <p>특히 staleTime을 지정해줘야 한다.</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">// provider.tsx</span>
<span class="token string">'use client'</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> QueryClient<span class="token punctuation">,</span> QueryClientProvider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@tanstack/react-query'</span>

<span class="token keyword">function</span> <span class="token function">makeQueryClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">QueryClient</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    defaultOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
      queries<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// SSR에서는 클라이언트에서 바로 다시 refetching 이 일어나는 것을 방지하기 위해</span>
        <span class="token comment">// staleTime을 0보다 크게 지정한다.</span>
        staleTime<span class="token operator">:</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> browserQueryClient<span class="token operator">:</span> QueryClient <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> <span class="token keyword">undefined</span>

<span class="token keyword">function</span> <span class="token function">getQueryClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> window <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 서버는 항상 쿼리 클라이언트를 생성한다. (매 요청마다)</span>
    <span class="token keyword">return</span> <span class="token function">makeQueryClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 브라우저에서 쿼리클라이언트가 없을 경우에 새로 만들게 된다.</span>
    <span class="token comment">// 최초 렌더링 중 suspend 돼도 새로운 쿼리 클라이언트를 생성하지 않고 단일 인스턴스로 이용.</span>
    <span class="token comment">// QueryClientProvider 아래에 Suspense Boundary가 있다면 필요하지 않을 수 있다.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>browserQueryClient<span class="token punctuation">)</span> browserQueryClient <span class="token operator">=</span> <span class="token function">makeQueryClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> browserQueryClient
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Providers</span><span class="token punctuation">(</span><span class="token punctuation">{</span> children <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// NOTE: 사이에 Suspense Boundary가 없다면 useState를 이용해 쿼리 클라이언트를 초기화하지 마라.</span>
  <span class="token comment">//       초기 렌더링 시에 에러가 발생하고 바운더리가 없다면 리액트는 쿼리 클라이언트를 날려버릴 것이다.</span>
  <span class="token keyword">const</span> queryClient <span class="token operator">=</span> <span class="token function">getQueryClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">QueryClientProvider</span></span> <span class="token attr-name">client</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>queryClient<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">QueryClientProvider</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// layout.tsx</span>
<span class="token keyword">import</span> Providers <span class="token keyword">from</span> <span class="token string">'./providers'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">RootLayout</span><span class="token punctuation">(</span><span class="token punctuation">{</span> children <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
		     </span><span class="token punctuation">{</span><span class="token comment">// 앱을 생성한 Provider로 감싼다. }</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Providers</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Providers</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><h2 id="hydration-api를-이용해-쿼리-클라이언트-dehydrate-hydrate-하기">Hydration API를 이용해 쿼리 클라이언트 dehydrate/hydrate 하기</h2> <p>pages router 환경과 app router 환경 모두 아래와 같은 방식으로 동작한다.</p> <ol><li>서버 사이드에서 쿼리 클라이언트 인스턴스 생성</li> <li>쿼리 클라이언트 인스턴스에서 쿼리 prefetch</li> <li>prefetch 된 쿼리가 있는 인스턴스를 dehydrate(직렬화)</li> <li>HydrationBoundary 컴포넌트의 state prop에 dehydrated client를 전달</li> <li>HydrationBoundary 안의 컴포넌트에서 <code>useQuery</code> 등 쿼리 사용</li></ol> <p>pages router와 app router의 차이점은 1,2,3 단계를 어떻게 하느냐의 차이에 있다.</p> <p>Next.js 공식 문서에서는 app router를 이용하는 경우 데이터를 가져오는 방법에 대해 소개하고 있다. <code>getServerSideProps</code>를 이용하는 대신 페이지 컴포넌트를 async로 정의하고, 데이터를 가져오는 함수를 await으로 호출하면 된다.</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://...'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> next<span class="token operator">:</span> <span class="token punctuation">{</span> tags<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'collection'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">// app/posts/page.jsx</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">PostsPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> queryClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// 쿼리 클라이언트에다가 Prefetching 해두기</span>
  <span class="token keyword">await</span> queryClient<span class="token punctuation">.</span><span class="token function">prefetchQuery</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    queryKey<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'posts'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    queryFn<span class="token operator">:</span> getPosts<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
	  <span class="token comment">// 그걸 그대로 직렬화 해서 state 로 지정.</span>
	  <span class="token comment">// HydrationBoundary는 Client Componenent.</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">HydrationBoundary</span></span> <span class="token attr-name">state</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">dehydrate</span><span class="token punctuation">(</span>queryClient<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Posts</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">HydrationBoundary</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="usedehydratestate로-깔끔하게-이용하기"><code>useDehydrateState</code>로 깔끔하게 이용하기</h2> <p>당연히 wrapping 해서 더 깔끔하게 이용할 수 있다.</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>export default async function useDehydratedState&lt;
  TQueryFnData = unknown,
  TError = Error,
  TData = TQueryFnData,
  TQueryKey extends QueryKey = QueryKey
&gt;(args: FetchQueryOptions&lt;TQueryFnData, TError, TData, TQueryKey&gt;) {
  const queryClient = new QueryClient();
  await queryClient.prefetchQuery(args);
  
  return dehydrate(queryClient);
}

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="refetching이-제대로-안된다">refetching이 제대로 안된다.</h2> <p>로컬 환경에서는 괜찮은데, 배포하고 나니 CSR 환경에서 refetching 할 때 오류가 발생한다. CSR 환경에서는 API 요청을 브라우저가 날리니까 제대로 동작하지 않을 수 밖에 없다. 그래서 return-fetch로 구성한 <code>fetchExtended</code> 함수를 수정해줬다.</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">// Create an extended fetch function</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">returnFetchJson</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// default options</span>
  baseUrl<span class="token operator">:</span> <span class="token string">&quot;http://localhost:3000&quot;</span><span class="token punctuation">,</span>
  interceptors<span class="token operator">:</span> <span class="token punctuation">{</span>
	  <span class="token comment">// 요청 시 기존 URL 가져와서 baseurl만 바꿔주기</span>
    <span class="token keyword">async</span> <span class="token function">request</span><span class="token punctuation">(</span>requestArgs<span class="token punctuation">,</span> fetch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> prevUrl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token constant">URL</span></span><span class="token punctuation">(</span>requestArgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> newUrl <span class="token operator">=</span>
        <span class="token keyword">typeof</span> window <span class="token operator">===</span> <span class="token string">&quot;undefined&quot;</span>
          <span class="token operator">?</span> prevUrl
          <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token constant">URL</span></span><span class="token punctuation">(</span>prevUrl<span class="token punctuation">.</span>pathname <span class="token operator">+</span> prevUrl<span class="token punctuation">.</span>search<span class="token punctuation">,</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token punctuation">[</span>newUrl<span class="token punctuation">,</span> requestArgs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="문자열-날짜-자동으로-파싱하기">문자열 날짜 자동으로 파싱하기</h2> <p>아래와 같이 응답으로 넘어온 객체에서 문자열로 된 날짜를 찾아 파싱해주게 했다.</p> <p>여러 날짜 컨벤션이 뒤섞인 경우라면 이런 것을 이용하지 않는 것이 낫겠지만, 1인 개발로 진행하는 만큼 적용해보았다.</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token operator">...</span>
<span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token function">handleDates</span><span class="token punctuation">(</span><span class="token function">parseJsonSafely</span><span class="token punctuation">(</span><span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
  
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">handleDates</span><span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isIsoDateString</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">parseISO</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> data <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> data <span class="token operator">!==</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> val<span class="token punctuation">]</span> <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isIsoDateString</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span> data<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">parseISO</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> val <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">)</span> <span class="token function">handleDates</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="데이터-fetching-함수-클래스로-관리하기">데이터 fetching 함수 클래스로 관리하기</h2> <p>아래와 같이 static method로 data fetching 함수를 관리하게 만들어줬다. 덕분에 쿼리 함수 호출부가 깔끔해졌다.</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">PostService</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">fetchPosts</span><span class="token punctuation">(</span>page<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token generic-function"><span class="token function">fetchExtended</span><span class="token generic class-name"><span class="token operator">&lt;</span>PostListDto<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&quot;/api/post?page=&quot;</span> <span class="token operator">+</span> page<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">fetchPost</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token generic-function"><span class="token function">fetchExtended</span><span class="token generic class-name"><span class="token operator">&lt;</span>PostDetailDto<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&quot;/api/post/&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="제-프로젝트-디렉토리-구조는요">제 프로젝트 디렉토리 구조는요..</h2> <p>우선은 아래와 같이 구성돼있다. page.tsx에서는 쿼리 클라이언트 생성/prefetch/dehydration이 진행될거고,</p> <p>HydrationBoundary 내부의 HomeContainer.tsx에서는 리액트 쿼리에 의해 자동으로 hydration된 쿼리가 주입돼있어서 바로 <code>useQuery</code> 를 이용해 데이터를 이용할 수 있게 된다. 이에 관한 data fetching  함수는 model/PostService.ts에 정의돼있다.</p> <p>완벽한 구조는 아니지만 나름 아키텍처에 맞게 레이어 별로 나누고자 했다.</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code>my<span class="token operator">-</span>own<span class="token operator">-</span>blog
├── app
│   └── page<span class="token punctuation">.</span>tsx <span class="token comment">// server component</span>
└── components
    ├── container
    │   └── HomeContainer<span class="token punctuation">.</span>tsx <span class="token comment">// client component</span>
    ├── hooks
    │   └── useHomeViewModel<span class="token punctuation">.</span>ts
    ├── model
    │   └── PostService<span class="token punctuation">.</span>ts
    └── queries
        └── usePostListQuery<span class="token punctuation">.</span>ts
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="느낀-점">느낀 점</h2> <p>음.. 생각보다 SSR과 react-query를 함께 이용하는 것이 만만치 않은 것이라는 것을 알게 되었다.</p> <p>그리고 next.js 의 SSR과 hydration에 대해 조금 더 알아보고 싶다는 생각이 들었다.</p> <p>그래도 나름 큰 성과는, 한가지 목표를 위해 여러 개의 영어로 된 공식 문서들을 해석하면서 이해하고, 실제 적용해보고, 문제 상황에 맞게 바꿔볼 수 있는 기회가 되어서 좋았다.</p></div> <div id="disqus_thread" class="comment"></div></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.0f0432c3.js" defer></script><script src="/assets/js/1.e51d5c6a.js" defer></script><script src="/assets/js/38.9f1b4753.js" defer></script>
  </body>
</html>
