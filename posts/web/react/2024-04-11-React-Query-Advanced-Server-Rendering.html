<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Next.js 에서 react-query 쓰기: Advanced Server Rendering | Wh@t !s Development?</title>
    <meta name="generator" content="VuePress 1.9.10">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-C7NTCRQ25E"></script>
    <script>window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-C7NTCRQ25E');</script>
    <meta name="description" content="배워가고 있는 현업..? 대학생 개발자">
    
    <link rel="preload" href="/assets/css/0.styles.410c9d99.css" as="style"><link rel="preload" href="/assets/js/app.0f0432c3.js" as="script"><link rel="preload" href="/assets/js/1.e51d5c6a.js" as="script"><link rel="preload" href="/assets/js/36.8eb956e4.js" as="script"><link rel="prefetch" href="/assets/js/10.af576f8c.js"><link rel="prefetch" href="/assets/js/11.8e7b7e6a.js"><link rel="prefetch" href="/assets/js/12.5d214f46.js"><link rel="prefetch" href="/assets/js/13.9a7e722a.js"><link rel="prefetch" href="/assets/js/14.5257cb5d.js"><link rel="prefetch" href="/assets/js/15.f5323db5.js"><link rel="prefetch" href="/assets/js/16.21bdef53.js"><link rel="prefetch" href="/assets/js/17.a26c4187.js"><link rel="prefetch" href="/assets/js/18.cc5832b6.js"><link rel="prefetch" href="/assets/js/19.9c2a758e.js"><link rel="prefetch" href="/assets/js/2.a73cb97e.js"><link rel="prefetch" href="/assets/js/20.274e5be3.js"><link rel="prefetch" href="/assets/js/21.aad67e55.js"><link rel="prefetch" href="/assets/js/22.6699120b.js"><link rel="prefetch" href="/assets/js/23.62e88c29.js"><link rel="prefetch" href="/assets/js/24.a9e172f9.js"><link rel="prefetch" href="/assets/js/25.9f6d5201.js"><link rel="prefetch" href="/assets/js/26.c6576b86.js"><link rel="prefetch" href="/assets/js/27.11b8553b.js"><link rel="prefetch" href="/assets/js/28.4f235f30.js"><link rel="prefetch" href="/assets/js/29.d9921336.js"><link rel="prefetch" href="/assets/js/30.49a4c0a3.js"><link rel="prefetch" href="/assets/js/31.581f6903.js"><link rel="prefetch" href="/assets/js/32.35749f3d.js"><link rel="prefetch" href="/assets/js/33.0eeaf8b7.js"><link rel="prefetch" href="/assets/js/34.bc5efa62.js"><link rel="prefetch" href="/assets/js/35.bc5e7fdd.js"><link rel="prefetch" href="/assets/js/37.f00c8127.js"><link rel="prefetch" href="/assets/js/38.9f1b4753.js"><link rel="prefetch" href="/assets/js/39.ba3af032.js"><link rel="prefetch" href="/assets/js/4.fa591364.js"><link rel="prefetch" href="/assets/js/40.ce9157d5.js"><link rel="prefetch" href="/assets/js/41.55cf01b3.js"><link rel="prefetch" href="/assets/js/42.13adade4.js"><link rel="prefetch" href="/assets/js/43.82fd5a46.js"><link rel="prefetch" href="/assets/js/44.69524c43.js"><link rel="prefetch" href="/assets/js/45.b5148874.js"><link rel="prefetch" href="/assets/js/46.8c9eea5a.js"><link rel="prefetch" href="/assets/js/47.1c6d2034.js"><link rel="prefetch" href="/assets/js/48.e5d7163d.js"><link rel="prefetch" href="/assets/js/49.2be3dee3.js"><link rel="prefetch" href="/assets/js/5.3285373e.js"><link rel="prefetch" href="/assets/js/50.1bc83e1d.js"><link rel="prefetch" href="/assets/js/51.86405db6.js"><link rel="prefetch" href="/assets/js/52.9992785d.js"><link rel="prefetch" href="/assets/js/53.cd97a3e5.js"><link rel="prefetch" href="/assets/js/54.fc7e5d0e.js"><link rel="prefetch" href="/assets/js/55.ee855e74.js"><link rel="prefetch" href="/assets/js/56.b71f792d.js"><link rel="prefetch" href="/assets/js/57.6c9afba0.js"><link rel="prefetch" href="/assets/js/58.ee457792.js"><link rel="prefetch" href="/assets/js/59.9de3ac46.js"><link rel="prefetch" href="/assets/js/6.1892a22d.js"><link rel="prefetch" href="/assets/js/60.66e2b70d.js"><link rel="prefetch" href="/assets/js/61.4ca17ece.js"><link rel="prefetch" href="/assets/js/62.1e40c143.js"><link rel="prefetch" href="/assets/js/63.349b896e.js"><link rel="prefetch" href="/assets/js/64.5ced3a0a.js"><link rel="prefetch" href="/assets/js/65.885a6b59.js"><link rel="prefetch" href="/assets/js/66.d33066c0.js"><link rel="prefetch" href="/assets/js/67.6cd8cdbb.js"><link rel="prefetch" href="/assets/js/68.b938c024.js"><link rel="prefetch" href="/assets/js/69.78092bd2.js"><link rel="prefetch" href="/assets/js/7.b7ddbb1c.js"><link rel="prefetch" href="/assets/js/70.3652d64c.js"><link rel="prefetch" href="/assets/js/71.97470014.js"><link rel="prefetch" href="/assets/js/72.3f43251e.js"><link rel="prefetch" href="/assets/js/73.4b1b6c82.js"><link rel="prefetch" href="/assets/js/74.a5c70ed4.js"><link rel="prefetch" href="/assets/js/75.126ed59b.js"><link rel="prefetch" href="/assets/js/76.7a449595.js"><link rel="prefetch" href="/assets/js/77.e9dda385.js"><link rel="prefetch" href="/assets/js/78.6910c049.js"><link rel="prefetch" href="/assets/js/79.f79dfc27.js"><link rel="prefetch" href="/assets/js/8.d36f1bbf.js"><link rel="prefetch" href="/assets/js/80.7d6014ad.js"><link rel="prefetch" href="/assets/js/81.f9600c48.js"><link rel="prefetch" href="/assets/js/82.46c9d211.js"><link rel="prefetch" href="/assets/js/83.ffbaed47.js"><link rel="prefetch" href="/assets/js/84.7c6d7c27.js"><link rel="prefetch" href="/assets/js/85.9c073b0f.js"><link rel="prefetch" href="/assets/js/86.bafebd90.js"><link rel="prefetch" href="/assets/js/87.05edd0bf.js"><link rel="prefetch" href="/assets/js/88.3123c9a0.js"><link rel="prefetch" href="/assets/js/89.607daa32.js"><link rel="prefetch" href="/assets/js/9.2f254d8e.js"><link rel="prefetch" href="/assets/js/90.21814a61.js"><link rel="prefetch" href="/assets/js/91.47d6c698.js">
    <link rel="stylesheet" href="/assets/css/0.styles.410c9d99.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="layout"><div id="navbar"><nav role="navigation" aria-label="main navigation" class="navbar"><div class="navbar-brand"><a href="/" class="navbar-item" style="font-weight:bold;color:black;">
      Wh@t !s Development?
    </a><a role="button" aria-label="menu" tabindex="0" class="navbar-burger burger"><span aria-hidden="true"></span><span aria-hidden="true"></span><span aria-hidden="true"></span></a></div><div class="navbar-menu"><div class="navbar-start"></div><div class="navbar-end"><a href="/" class="navbar-item">
      Home
    </a><a href="/about" class="navbar-item">
      About
    </a> <a href="/posts/app" class="navbar-item">
      앱
    </a><a href="/posts/cs" class="navbar-item">
      CS
    </a><a href="/posts/web" class="navbar-item">
      Web
    </a><a href="/posts/etc" class="navbar-item">
      그 외
    </a> <div class="navbar-item"><div class="buttons"><button type="button" class="button is-info"><!----><!----><span class="icon is-small"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="svg-inline--fa fa-github fa-w-16"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></span></button> <button type="button" class="button is-info"><!----><!----><span class="icon is-small"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="instagram" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="svg-inline--fa fa-instagram fa-w-14"><path fill="currentColor" d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"></path></svg></span></button> <button type="button" class="button is-info"><!----><span><span class="icon is-small"><img src="/images/white_notion.svg" width="15" height="15"></span></span><!----></button></div></div></div></div></nav></div> <div class="content"><div class="page post"><div class="columns"><div class="column"><p class="title is-4">Next.js 에서 react-query 쓰기: Advanced Server Rendering</p></div></div> <p class="subtitle is-5 date">2024-04-11 23:45:00</p> <div class="content__default" style="paddig:0;"><img src="/assets/img/2.57652cfd.png"> <h3 id="서버-컴포넌트와-next-js-앱-라우터">서버 컴포넌트와 Next.js 앱 라우터</h3> <p>서버 컴포넌트는 초기 페이지 렌더 및 페이지 전환 시 모두 서버에서만 구동되는 컴포넌트이다. 서버 컴포넌트의 동작 방식은 서버에서만 돌아가고, 데이터만을 반환한다는 점에서 Next.js의 <code>getServerSideProps</code> 나 <code>getStaticProps</code> , 혹은 Remix의 <code>loader</code> 함수가 동작하는 것과 같지만, 서버 컴포넌트는 더 많은 것을 할 수 있다. 어쨌든 데이터 부분은 리액트 쿼리의 중심이다.</p> <p>pages router 환경에서 Hydration API를 이용하는 방법을 어떻게 Next.js의 app router에 적용할 수 있을까? 가장 나은 방법은 서버 컴포넌트를 “그냥” 또 다른 프레임워크 로더로서 생각하는 것이다.</p> <h3 id="전문-용어에-관한-빠른-설명">전문 용어에 관한 빠른 설명</h3> <p>지금까지 이 가디드에서 “서버”와 “클라이언트”에 대해 이야기해 왔다. 혼란스럽게도, 서버 컴포넌트와 클라이언트 컴포넌트가 “서버”와 “클라이언트”에 1대1로 매칭되지 않는 점이 중요하다. 서버 컴포넌트는 서버에서 돌아가기를 보장받는다. 하지만 클라이언트 컴포넌트는 사실 서버와 클라이언트 모두에서 돌아갈 수 있다. 왜냐하면 클라이언트 컴포넌트는 최초 서버 렌더링 과정에서도 렌더 되기 때문이다.</p> <p>서버 컴포넌트는 렌더되지만, 이 동작은 항상 <strong>서버에서</strong> “loader 단계” 에서만 실행된다. 반면에 클라이언트 컴포넌트는 “application 단계” 에서 실행되는데, 애플리케이션은 서버에서 SSR 중에서도 실행될 수 있고, 클라이언트 단인 브라우저에서도 실행될 수 있다.</p> <p>*첨언: 사실 당연한 이야기 아닌가..?</p> <h3 id="최초-설정">최초 설정</h3> <p>당연히 <code>queryClient</code> 생성부터 시작한다.</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token string">'use client'</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> QueryClient<span class="token punctuation">,</span> QueryClientProvider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@tanstack/react-query'</span>

<span class="token keyword">function</span> <span class="token function">makeQueryClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">QueryClient</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">defaultOptions</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">queries</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// SSR에서는 클라이언트에서 바로 다시 refetching 이 일어나는 것을 방지하기 위해</span>
        <span class="token comment">// staleTime을 0보다 크게 지정한다.</span>
        <span class="token literal-property property">staleTime</span><span class="token operator">:</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> <span class="token literal-property property">browserQueryClient</span><span class="token operator">:</span> QueryClient <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> <span class="token keyword">undefined</span>

<span class="token keyword">function</span> <span class="token function">getQueryClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> window <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 서버는 항상 쿼리 클라이언트를 생성한다. (매 요청마다)</span>
    <span class="token keyword">return</span> <span class="token function">makeQueryClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 브라우저에서 쿼리클라이언트가 없을 경우에 새로 만들게 된다.</span>
    <span class="token comment">// 최초 렌더링 중 suspend 돼도 새로운 쿼리 클라이언트를 생성하지 않고 단일 인스턴스로 이용.</span>
    <span class="token comment">// QueryClientProvider 아래에 Suspense Boundary가 있다면 필요하지 않을 수 있다.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>browserQueryClient<span class="token punctuation">)</span> browserQueryClient <span class="token operator">=</span> <span class="token function">makeQueryClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> browserQueryClient
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">Providers</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// NOTE: 사이에 Suspense Boundary가 없다면 useState를 이용해 쿼리 클라이언트를 초기화하지 마라.</span>
  <span class="token comment">//       초기 렌더링 시에 에러가 발생하고 바운더리가 없다면 리액트는 쿼리 클라이언트를 날려버릴 것이다.</span>
  <span class="token keyword">const</span> queryClient <span class="token operator">=</span> <span class="token function">getQueryClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">QueryClientProvider</span></span> <span class="token attr-name">client</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>queryClient<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">QueryClientProvider</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token keyword">import</span> Providers <span class="token keyword">from</span> <span class="token string">'./providers'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">RootLayout</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
		     </span><span class="token punctuation">{</span><span class="token comment">// 앱을 생성한 Provider로 감싼다. }</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Providers</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Providers</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="pre-fetching-하고-데이터-de-hydrate-하기">Pre-fetching 하고 데이터 de-hydrate 하기</h3> <p>아래는 pages router를 이용한 예제이다.</p> <p>여기에서 핵심 요소만 빼서 그대로 App Router로 이전이 가능하다.</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token comment">// This could also be getServerSideProps</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getStaticProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> queryClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> queryClient<span class="token punctuation">.</span><span class="token function">prefetchQuery</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    queryKey<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'posts'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    queryFn<span class="token operator">:</span> getPosts<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    props<span class="token operator">:</span> <span class="token punctuation">{</span>
      dehydratedState<span class="token operator">:</span> <span class="token function">dehydrate</span><span class="token punctuation">(</span>queryClient<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">Posts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useQuery</span><span class="token punctuation">(</span><span class="token punctuation">{</span> queryKey<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'posts'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> queryFn<span class="token operator">:</span> getPosts <span class="token punctuation">}</span><span class="token punctuation">)</span>
  
  <span class="token keyword">const</span> <span class="token punctuation">{</span> data<span class="token operator">:</span> commentsData <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useQuery</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    queryKey<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'posts-comments'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    queryFn<span class="token operator">:</span> getComments<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">PostsRoute</span><span class="token punctuation">(</span><span class="token punctuation">{</span> dehydratedState <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">HydrationBoundary</span></span> <span class="token attr-name">state</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>dehydratedState<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Posts</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">HydrationBoundary</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token comment">// app/posts/page.jsx</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  dehydrate<span class="token punctuation">,</span>
  HydrationBoundary<span class="token punctuation">,</span>
  QueryClient<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@tanstack/react-query'</span>
<span class="token keyword">import</span> Posts <span class="token keyword">from</span> <span class="token string">'./posts'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">PostsPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> queryClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// 쿼리 클라이언트에다가 Prefetching 해두기</span>
  <span class="token keyword">await</span> queryClient<span class="token punctuation">.</span><span class="token function">prefetchQuery</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">queryKey</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'posts'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">queryFn</span><span class="token operator">:</span> getPosts<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
	  <span class="token comment">// 그걸 그대로 직렬화 해서 state 로 지정.</span>
	  <span class="token comment">// HydrationBoundary는 Client Componenent.</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">HydrationBoundary</span></span> <span class="token attr-name">state</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">dehydrate</span><span class="token punctuation">(</span>queryClient<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Posts</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">HydrationBoundary</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="적용해보고-나니">적용해보고 나니</h3> <p>SSR 개념에 조금 더 한발짝 다가갈 수 있었고, Next.js 의 서버 컴포넌트와 클라이언트 컴포넌트 개념에 대해 조금 더 심도 있는 이해를 하게 됐다. 그리고 쿼리클라이언트를 직렬화해서 클라이언트 컴포넌트 단에 내려주고, 클라이언트에 있는 캐시를 이용할 생각을 한건 정말 기발한 생각인 것 같다.</p> <h3 id="과제">과제</h3> <p>아직 여러가지 해결할 과제들이 남아있다.</p> <p>페이지 파일과 실제 UI 컴포넌트를 나눴는데, 이 파일들을 어떻게 정리하고 아키텍처화 할지도 고민이고,</p> <p>공식문서에 아직 더 남아 있는 쿼리클라이언트 캐싱이라던가 해볼 것들이 조금 있다.</p> <p>우선은 이걸로 충분해 보이는데, 부족한 점이 더 발견돼서 수정할 수도 있다.</p> <p>그리고 아래 블로그에서 본 코드를 드디어 이해할 수 있게 되었고, experimental 기능인 스트리밍도 눈여겨볼 만 하다고 생각돼 단순 구현이 아닌 더 나은 코드 품질로 이어지게 고민해봐야겠다.</p> <p><a href="https://soobing.github.io/react/next-app-router-react-query/" target="_blank" rel="noopener noreferrer">[React-Query] Next.js app router에서 사용하면서 고민했던 것들<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <div id="disqus_thread" class="comment"></div></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.0f0432c3.js" defer></script><script src="/assets/js/1.e51d5c6a.js" defer></script><script src="/assets/js/36.8eb956e4.js" defer></script>
  </body>
</html>
